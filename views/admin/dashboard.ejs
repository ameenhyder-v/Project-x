<%- include("../partials/adminpartials/adminHeader.ejs") %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="index.html" class="brand-wrap">
                <img src="/assets/imgs/theme/logo.svg" class="logo" alt="Nest Dashboard" />
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item active">
                    <a class="menu-link" href="/admin/dashboard">
                        <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/productlist">
                        <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span>
                    </a>
                </li>

                <li class="menu-item">
                    <a class="menu-link" href="/admin/addProduct">
                        <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Add product</span>
                    </a>
                </li>

                <li class="menu-item">
                    <a class="menu-link" href="/admin/orders">
                        <i class="icon material-icons md-list_alt"></i>
                        <span class="text">Orders</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a class="menu-link" href="/admin/users">
                        <i class="icon material-icons md-people"></i>
                        <span class="text">Users</span>
                    </a>
                </li>

                <li class="menu-item">
                    <a class="menu-link" href="/admin/Categories">
                        <i class="icon material-icons md-layers"></i>
                        <span class="text">Categories</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a class="menu-link" href="/admin/coupon">
                        <i class="icon material-icons md-local_offer"></i>
                        <span class="text">Coupon Management</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a class="menu-link" href="/admin/offer">
                        <i class="icon material-icons md-local_offer"></i>
                        <span class="text">Offer Management</span>
                    </a>
                </li>
                <li class="menu-item ">
                    <a class="menu-link" disabled href="/admin/sales-report">
                        <i class="icon material-icons md-insert_chart"></i>
                        <span class="text">Sales Report</span>
                    </a>
                </li>
            </ul>
            <br />
            <br />
        </nav>
    </aside>
<main class="main-wrap">
    <header class="main-header navbar">
        
        <div class="col-nav">
            <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i class="material-icons md-apps"></i></button>
            <ul class="nav">
                <% if (returnMessage && returnMessage.length > 0) { %>
                    <li class="nav-item">
                        <a class="nav-link btn-icon" href="#" data-bs-toggle="modal" data-bs-target="#returnRequestsModal">
                            <i class="material-icons md-notifications "></i>
                            <span class="badge rounded-pill"><%= returnMessage.length %></span>
                            Return Requests
    
                        </a>
                    </li>
                <% } else{ %>
                    <li class="nav-item">
                            <i class="material-icons md-notifications "></i>
                            Return Requests
    
                        </a>
                    </li>
                    <% } %>
                <li class="nav-item">
                    <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                </li>
            </ul>
        </div>
    </header>
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Dashboard</h2>
                <p>Whole data about your business here</p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-primary-light">
                            <i class="text-primary material-icons md-monetization_on"></i>
                        </span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Revenue</h6>
                            <span>â‚¹ <%= totalSales.toFixed(2) %></span> <!-- Display the total sales amount -->
                            <span class="text-sm"> Only that have delivered </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-success-light">
                            <i class="text-success material-icons md-local_shipping"></i>
                        </span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Delivered Orders</h6> <!-- Update title to reflect delivered orders -->
                            <span><%= totalDeliveredOrders %></span> <!-- Display the total delivered orders -->
                            <span class="text-sm"> Total orders delivered </span>
                        </div>
                    </article>
                </div>
            </div>
            <!-- <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Products</h6>
                            <span>9.856</span>
                            <span class="text-sm"> In 19 Categories </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-info-light"><i class="text-info material-icons md-shopping_basket"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Monthly Earning</h6>
                            <span>$6,982</span>
                            <span class="text-sm"> Based in your local time. </span>
                        </div>
                    </article>
                </div>
            </div> -->
        </div>
        <div class="row">
            <div class="col-xl-8 col-lg-12">
                <div class="card mb-4">
                    <article class="card-body">
                        <h5 class="card-title">Sale Statistics</h5>
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-primary" onclick="fetchSalesData('daily')">Daily</button>
                            <button type="button" class="btn btn-primary" onclick="fetchSalesData('weekly')">Weekly</button>
                            <button type="button" class="btn btn-primary" onclick="fetchSalesData('monthly')">Monthly</button>
                            <button type="button" class="btn btn-primary" onclick="fetchSalesData('yearly')">Yearly</button>
                        </div>
                        <canvas id="salesChart" height="120px"></canvas>
                    </article>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <header class="card-header">
                <h4 class="card-title">Latest orders</h4>
            </header>
            <div class="card-body">
                <div class="table-responsive">
                    <div class="table-responsive">
                        <table class="table align-middle table-nowrap mb-0">
                            <thead class="table-light">
                              <tr>
                                <th class="align-middle" scope="col">Order ID</th>
                                <th class="align-middle" scope="col">Billing Name</th>
                                <th class="align-middle" scope="col">Date</th>
                                <th class="align-middle" scope="col">Total</th>
                                <th class="align-middle" scope="col">Payment Status</th>
                                <th class="align-middle" scope="col">Payment Method</th>
                                <th class="align-middle" scope="col">View Details</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% newOrders.forEach(order => { %>
                                <tr>
                                  <td><a href="#" class="fw-bold">#<%= order.orderId %></a></td>
                                  <td><%= order.billingName %></td>
                                  <td><%= new Date(order.date).toLocaleDateString() %></td>
                                  <td>$<%= order.total.toFixed(2) %></td>
                                  <td>
                                    <span class="badge badge-pill badge-soft-<%= order.paymentStatus === 'Paid' ? 'success' : 'danger' %>">
                                      <%= order.paymentStatus %>
                                    </span>
                                  </td>
                                  <td><i class="material-icons md-payment font-xxl text-muted mr-5"></i> <%= order.paymentMethod %></td>
                                  <td>
                                    <a href="/admin/order-detail?orderId=<%= order.id %>" class="btn btn-xs">View details</a>
                                  </td>
                                </tr>
                              <% }) %>
                            </tbody>
                          </table>
                          
                    </div>
                </div>
                <!-- table-responsive end// -->
            </div>
        </div>
    </section>
    <!-- content-main end// -->
    <%- include("../partials/adminpartials/adminFooter.ejs") %>


    <div class="modal fade dark" id="returnRequestsModal" tabindex="-1" aria-labelledby="returnRequestsModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width: 600px;">
            <div class="modal-content" style="background-color: rgb(68, 68, 68);">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnRequestsModalLabel" style="color: white;">Return Requests</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
                </div>
                <div class="modal-body" style="background-color: rgb(68, 68, 68); color: white;">
                    <% if (returnMessage && returnMessage.length > 0) { %>
                        <ul class="list-group">
                            <% returnMessage.forEach(request => { %>
                                <li class="list-group-item" style="background-color: rgb(68, 68, 68); color: white;">
                                    <strong>User:</strong> <%= request.user.name %> <br>
                                    <strong>Reason:</strong> <%= request.reason %> <br>
                                    <a href="/admin/order-detail?orderId=<%= request.orderDataId %>"><strong>view</strong></a>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <p>No return requests available.</p>
                    <% } %>
                </div>
                <div class="modal-footer" style="background-color: rgb(68, 68, 68);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



<script>
    let salesChartInstance;

    async function fetchSalesData(filter) {
        try {
            const response = await fetch(`/admin/sales-chart?filter=${filter}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
    
            const data = await response.json();
    
            if (data.labels && data.values) {
                updateSalesChart(data.labels, data.values, filter);
            } 
        } catch (error) {
            console.error('Error fetching sales data:', error);
            alert(`An error occurred while fetching sales data: ${error.message}. Please try again later.`);
        }
    }
    


    function updateSalesChart(labels, values, filter) {
        if (!Array.isArray(labels) || !Array.isArray(values) || labels.length !== values.length) {
            console.error("Invalid labels or values. They must be arrays of the same length.");
            return;
        }
    
        const ctx = document.getElementById('salesChart');
        if (!ctx) {
            console.error("Canvas element with id 'salesChart' not found.");
            return;
        }
    
        try {
            if (salesChartInstance) {
                salesChartInstance.data.labels = labels;
                salesChartInstance.data.datasets[0].data = values;
                salesChartInstance.update();
            } else {
                salesChartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Sales',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Sales Amount'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: filter.charAt(0).toUpperCase() + filter.slice(1) 
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error("Error updating or creating chart:", error);
        }
    }
        
        

        window.onload = () => {
            fetchSalesData('daily');
        };
</script>